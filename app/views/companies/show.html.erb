<main role="main">
  <div class="container" style="padding-top:50px; padding-bottom:50px">
    <div class="row">
      <div class="col-md-4">
        <div class="card mb-4 shadow-sm">
          <div class="logo">
            <%= image_tag(@company.picture.url, class: "img-thumbnail float comment-image") if @company.picture? %>
          </div>
          <div class="card-body">
            <div class="lcrt" data-gpa="3.7">
                <b class="avg"><%= @company.average_review.round(1) %> <i class='fa fa-star fa-fw'></i></b>
                <span class="avg-count"><%= @company.reviews.count %> reviews</span>
                <span class="like-count"><%= @company.get_upvotes.size %> likes</span>

            </div>
            <div id="chart_div"></div>
            <% if !current_user %>
            <p class="signup-link"><a href="/users/sign_in">Sign in to rate</a></p>
            <% end %>
            <div class="d-flex justify-content-between align-items-center">
              <% if current_user %>
                <div class="btn-group">
                  <%= link_to like_company_path(@company), class: "like-btn btn btn-sm btn-outline-secondary", method: :put, remote: :true do %>
                    <div>
                      <span id="like_prompt">
                        <% if current_user.liked? @company %>
                          Unlike
                        <% else %>
                          Like
                        <% end %>
                      </span>
                    </div>
                  <% end %>
                </div>
                <div>
                  <div class='rating-stars text-center'>
                    <br/>
                    <ul id='stars'>
                      <li class='star' title='Poor' data-value='1'>
                        <i class='fa fa-star fa-fw'></i>
                      </li>
                      <li class='star' title='Fair' data-value='2'>
                        <i class='fa fa-star fa-fw'></i>
                      </li>
                      <li class='star' title='Good' data-value='3'>
                        <i class='fa fa-star fa-fw'></i>
                      </li>
                      <li class='star' title='Excellent' data-value='4'>
                        <i class='fa fa-star fa-fw'></i>
                      </li>
                      <li class='star' title='WOW!!!' data-value='5'>
                        <i class='fa fa-star fa-fw'></i>
                      </li>
                    </ul>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        
      </div>
      <div class="col-sm-8">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-11">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab"
                       aria-controls="home" aria-selected="true">Company Information</a>
                  </li>
                  <% if @recruit %>
                  <li class="nav-item">
                    <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab"
                       aria-controls="profile" aria-selected="false">Recruit</a>
                  </li>
                  <% end %>
                  <% if @compensation %>
                  <li class="nav-item">
                    <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab"
                       aria-controls="contact" aria-selected="false">Compensation</a>
                  </li>
                  <% end %>
                </ul>
              </div>
            </div>
            <div class="tab-content" id="myTabContent">
              <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <table class="table table-hover">
                  <tbody>
                    <tr>
                      <td style="border-top:none">Name:</td>
                      <td style="border-top:none">
                        <%= @company.name %>
                      </td>
                    </tr>
                    <tr>
                      <td>Address:</td>
                      <td>
                        <%= @company.address %>
                      </td>
                    </tr>
                    <tr>
                      <td>Representative_name</td>
                      <td>
                        <%= @company.representative_name %>
                      </td>
                    </tr>
                    <tr>
                      <td>Representative_role</td>
                      <td>
                        <%= @company.representative_role %>
                      </td>
                    </tr>
                    <p>
                      <tr>
                        <td>Foundation</td>
                        <td>
                          <%= @company.foundation %>
                        </td>
                      </tr>
                      <td>Vietnam representative</td>
                      <td>
                        <% if @company.vietnam_representative != '0' %>
                          Yes
                        <% else %>
                          No
                        <% end %>
                      </td>
                    </tr>
                    <tr>
                      <td>Business content:</td>
                      <td>
                        <%= @company.business_content %>
                      </td>
                    </tr>
                    <tr>
                      <td>Code language:</td>
                      <td>
                        <%= @company.code_language %>
                      </td>
                    </tr>
                    <tr>
                      <td>Work time:</td>
                      <td>
                        <%= @company.work_time %>
                      </td>
                    </tr>
                    <tr>
                      <td>Work hour:</td>
                      <td>
                        <%= @company.work_hour %>
                      </td>
                    </tr>
                    <tr>
                      <td>Appeal:</td>
                      <td>
                        <%= @company.appeal %>
                      </td>
                    </tr>
                    <tr>
                      <td>Other:</td>
                      <td>
                        <%= @company.other %>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <% if @recruit %>
              <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <table class="table table-hover">
                  <tbody>
                    <tr>
                      <td style="border-top:none">Work type</td>
                      <td style="border-top:none">
                        <%=  @recruit.work_type  %>
                      </td>
                    </tr>
                    <tr>
                      <td>Number of employee</td>
                      <td>
                        <%= @recruit.employee_no %>
                      </td>
                    </tr>
                    <tr>
                      <td>Work place</td>
                      <td>
                        <%= @recruit.workplace %>
                      </td>
                    </tr>
                    <tr>
                      <td>Applicable student</td>
                      <td>
                        <%= @recruit.applicable_student %>
                      </td>
                    </tr>
                    <tr>
                      <td>Japanese level:</td>
                      <td>
                        <%= @recruit.japanese_level %>
                      </td>
                    </tr>
                    <tr>
                      <td>English level:</td>
                      <td>
                        <%= @recruit.english_level %>
                      </td>
                    </tr>
                    <tr>
                      <td>Personality desired</td>
                      <td>
                        <%= @recruit.personality_desired %>
                      </td>
                    </tr>
                    <tr>
                      <td>Status:</td>
                      <td>
                        <%= @recruit.status %>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <% end %>
              <% if @compensation %>
              <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                <table class="table table-hover">
                  <tbody>
                    <tr>
                      <td style="border-top:none">Insurance</td>
                      <td style="border-top:none">
                        <%= @compensation.insurance %>
                      </td>
                    </tr>
                    <tr>
                      <td>Holiday</td>
                      <td>
                        <%= @compensation.holiday %>
                      </td>
                    </tr>
                    <tr>
                      <td>Paid holidays</td>
                      <td>
                        <%= @compensation.paid_holidays %>
                      </td>
                    </tr>
                    <tr>
                        <td>Annual salary</td>
                        <td>
                          <%= @compensation.annual_salary %>
                        </td>
                    </tr>
                    <tr>
                      <td>Month salary</td>
                      <td>
                        <%= @compensation.month_salary %>
                      </td>
                    </tr>
                    <tr>
                      <td>Bonus:</td>
                      <td>
                       <%= @compensation.bonus %>
                      </td>
                    </tr>
                    <tr>
                      <td>Pay rise:</td>
                      <td>
                        <%= @compensation.pay_rise %>
                      </td>
                    </tr>
                    <tr>
                      <td>House allowance:</td>
                      <td>
                        <%= @compensation.housing_allowance %>
                      </td>
                    </tr>
                    <tr>
                      <td>Other allowance:</td>
                      <td>
                        <%= @compensation.other_allowance %>
                      </td>
                    </tr>
                    <tr>
                      <td>Commuting allowance:</td>
                      <td>
                        <%= @compensation.commuting_allowance %>
                      </td>
                    </tr>
                    <tr>
                      <td>Retirement:</td>
                      <td>
                        <%= @compensation.retirement %>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <h2>Comments</h2>
      <% if !current_user %><a href="/users/sign_in">(Sign in to comment)</a><% end %>
      <hr/>
      <section id="comments-section">
        <% if current_user %>
          <form class="new_comment" id="new_comment" action="/companies/<%= @company.id %>/comments" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="✓">
            <ol>
              <div class="row" style="padding-top:10px;">
                <div class="col-md-1">
                  <% if current_user.picture.presence %>
                    <%= image_tag(current_user.picture.thumb.url, class: "rounded-circle mx-auto d-block float-left", alt: "image", width: "75px", height: "75px") %>
                  <% else %>
                    <img src="http://www.personalbrandingblog.com/wp-content/uploads/2017/08/blank-profile-picture-973460_640-300x300.png"
             class="rounded-circle mx-auto d-block" alt="image" width="75px" height="75px">
                  <% end %>
                </div>
                <div class="col-md-11" style="padding-left:30px;">
                  <li>
                    <textarea rows="2" cols="60" placeholder="Write your comment here" name="comment[content]" id="comment_content"></textarea>
                  </li>
                  <li>
                    <input type="submit" name="commit" value="Comment" class="button" data-disable-with="Comment">
                  </li>
                </div>
              </div>
            </ol>
          </form>
          <hr/>
        <% end %>
        <ol id="comments">
          <%= render @comments %>
        </ol>
      </section>
    </div>
  </div>
</main>
<% if current_user %>
  <script>
    $(document).ready(function(){
        var rated = 0;
        <% if @cur_review %>
        rated = <%=  @cur_review.rating %>;
        <% end %>
    
        let stars = $(`#stars`).find(`li`).parent().children('li.star');
        for (let i = 0; i < rated; i++) {
            $(stars[i]).addClass('selected');
        }
        $('#stars li').on('mouseover', function(){
            var onStar = parseInt($(this).data('value'), 10); // The star currently mouse on
    
            // Now highlight all the stars that's not after the current hovered star
            $(this).parent().children('li.star').each(function(e){
                if (e < onStar) {
                    $(this).addClass('hover');
                }
                else {
                    $(this).removeClass('hover');
                }
            });
    
        }).on('mouseout', function(){
            $(this).parent().children('li.star').each(function(e){
                $(this).removeClass('hover');
            });
        });
    
    
        $('#stars li').on('click', function(){
            var onStar = parseInt($(this).data('value'), 10); 
            var stars = $(this).parent().children('li.star');
    
            for (i = 0; i < stars.length; i++) {
                $(stars[i]).removeClass('selected');
            }
    
            for (i = 0; i < onStar; i++) {
                $(stars[i]).addClass('selected');
            }
    
    
            var ratingValue = parseInt($('#stars li.selected').last().data('value'), 10);
            var user_id = <%= current_user.id %>;
            var company_id = <%= @company.id %>;
            var settings = {
                "async": true,
                "crossDomain": true,
                "url": `http://localhost:3000/companies/${company_id}/reviews`,
                "method": "POST",
                "headers": {
                    "Content-Type": "application/json",
                    "cache-control": "no-cache",
                },
                "processData": false,
                "data":  `{"rating":"${ratingValue}", "user_id":"${user_id}"}`
            }
    
            $.ajax(settings).done(function (response) {
                $( ".avg-count" ).text(`${response.count} reviews `);
                $( ".avg" ).html(`${response.average} <i class='fa fa-star fa-fw'></i>`);
                google.charts.setOnLoadCallback(function() { 
                  drawBasic(response.review['5'],response.review['4'],response.review['3'],response.review['2'],response.review['1']); 
                });
            });
        });
    });
  </script>
  <script>
    $(document).ready(function(){
        $("body").delegate(".reply-button", "click",function(event){
          let comment_id = $(event.target).attr('id');
          event.preventDefault();
          if($(event.target).closest(".comment").find(".reply-form").length != 0){
            return;
          }
          $(event.target).closest(".comment").append(`
          <div class="reply-form">
            <div class="row" style="padding-top:10px;">
              <div class="col-md-1">
              </div>
              <div class="col-md-1">
                <% if current_user.picture.presence %>
                  <%= image_tag(current_user.picture.thumb.url, class: "rounded-circle mx-auto d-block float-left", alt: "image", width: "75px", height: "75px") %>
                <% else %>
                  <img src="http://www.personalbrandingblog.com/wp-content/uploads/2017/08/blank-profile-picture-973460_640-300x300.png"
                        class="rounded-circle mx-auto d-block" alt="image" width="75px" height="75px">
                <% end %>
              </div>
              <div class="col-md-10" style="padding-left:30px;">
                <li>
                  <textarea rows="2" cols="60" placeholder="Write your comment here" class = "reply-text"></textarea>
                </li>
                <li>
                <input type="submit" name="commit" value="Comment" id="${comment_id}"  class = "button reply">
                </li>
              </div>
            </div>
          </div>
      `);
        });
    
    
        $("body").delegate(".reply", "click",function(event){
            let comment_id = $(event.target).attr('id');
            let content = $(event.target).closest(".reply-form").find(".reply-text").val();
            content = content.trim();
            if (content === "" || content.length === 0 || content == null|| !content.replace(/\s/g, '').length){
              alert('Comment cannot be blank!');
              return;
            }
            let user_id = <%= current_user.id %>;
            let company_id = <%= @company.id %>;
            let user_name = `<%= current_user.email %>`;
            var settings = {
              "async": true,
              "crossDomain": true,
              "url": `http://localhost:3000/companies/${company_id}/comments/${comment_id}/replies`,
              "method": "POST",
              "headers": {
                "Content-Type": "application/json",
                "cache-control": "no-cache",
              },
              "processData": false,
              "data":  `{"content":"${content}", "user_id":"${user_id}"}`
            }
    
            $.ajax(settings).done(function (response) {
              $(event.target).closest(".reply-form").replaceWith(`
                <div class="reply-comment">
                  <div class="row">
                    <div class="col-md-1 align-self-center">
                    </div>
                    <div class="col-md-1 align-self-center">
                      <% if current_user.picture.presence %>
                        <%= image_tag(current_user.picture.thumb.url, class: "rounded-circle mx-auto d-block float-left", alt: "image", width: "75px", height: "75px") %>
                      <% else %>
                        <img src="http://www.personalbrandingblog.com/wp-content/uploads/2017/08/blank-profile-picture-973460_640-300x300.png"
                          class="rounded-circle mx-auto d-block" alt="image" width="75px" height="75px">
                      <% end %>
                    </div>
                    <div class="col-md-10">
                      <div class="card" style="border: none">
                        <div class="card-body">
                          <a href="/users/${user_id}">${user_name}</a>
                          <span class="date">just now</span>
                          <p>${content}</p>
                            <a href="#" id="${response.data.id}" class="reply-delete">Delete</a>
                            <a href="#" id="${response.data.id}" class="reply-edit">Edit</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `);
            });
    
        });
    
    });
  </script>
  <script>
    $("body").delegate(".reply-edit", "click",function(event){

      let reply_id = $(event.target).attr('id');
      let current_content = $(event.target).closest(".reply-comment").find("p").text();
      event.preventDefault();
      $(event.target).closest(".reply-comment").replaceWith(`
          <div class="reply-form">
            <div class="row" style="padding-top:10px;">
              <div class="col-md-1">
              </div>
              <div class="col-md-1">
                <% current_user && if current_user.picture.presence %>
                  <%= image_tag(current_user.picture.thumb.url, class: "rounded-circle mx-auto d-block float-left", alt: "image", width: "75px", height: "75px") %>
                <% else %>
                  <img src="http://www.personalbrandingblog.com/wp-content/uploads/2017/08/blank-profile-picture-973460_640-300x300.png"
                        class="rounded-circle mx-auto d-block" alt="image" width="75px" height="75px">
                <% end %>
              </div>
              <div class="col-md-10" style="padding-left:30px;">
                <li>
                  <textarea rows="2" cols="60" placeholder="Write your comment here" class = "reply-text">${current_content}</textarea>
                </li>
                <li>
                <input type="submit" name="commit" value="Update" id="${reply_id}"  class = "button reply-update">
                </li>
              </div>
            </div>
          </div>
      `);
    });
  </script>
  <script>
    $("body").delegate(".reply-update", "click",function(event){
      event.preventDefault();
      let reply_id = $(event.target).attr('id');
      let content = $(event.target).closest(".reply-form").find(".reply-text").val();
      
      content = content.trim();
      if (content === "" || content.length === 0 || content == null|| !content.replace(/\s/g, '').length){
            alert('Comment cannot be blank!');
            return false;
      }
      let user_id = <%= current_user.id %>;
      let company_id = <%= @company.id %>;
      let user_name = `<%= current_user.email %>`;
      var settings = {
        "async": true,
        "crossDomain": true,
        "url": `http://localhost:3000/replies/${reply_id}`,
        "method": "PUT",
        "headers": {
          "Content-Type": "application/json",
          "cache-control": "no-cache",
        },
        "processData": false,
        "data": `{"content":"${content}"}`
      }
    
      $.ajax(settings).done(function (response) {
        $(event.target).closest(".reply-form").replaceWith(`
        <div class="reply-comment">
          <div class="row">
            <div class="col-md-1 align-self-center">
            </div>
            <div class="col-md-1 align-self-center">
              <% if current_user.picture.presence %>
                <%= image_tag(current_user.picture.thumb.url, class: "rounded-circle mx-auto d-block float-left", alt: "image", width: "75px", height: "75px") %>
              <% else %>
                <img src="http://www.personalbrandingblog.com/wp-content/uploads/2017/08/blank-profile-picture-973460_640-300x300.png"
                  class="rounded-circle mx-auto d-block" alt="image" width="75px" height="75px">
              <% end %>
            </div>
            <div class="col-md-10">
              <div class="card" style="border: none">
                <div class="card-body">
                  <a href="/users/${user_id}">${user_name}</a>
                  <span class="date">just now</span>
                  <p>${content}</p>
                    <a href="#" id="${reply_id}" class="reply-delete">Delete</a>
                    <a href="#" id="${reply_id} class="reply-edit">Edit</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `);
      });
    });
  </script>
  <script>
    $("body").delegate(".reply-delete", "click",function(event){
      event.preventDefault();
      let reply_id = $(event.target).attr('id');
      var r = confirm("Delete this comment?");
      if (r == false) {
          return;
      }
      var settings = {
        "async": true,
        "crossDomain": true,
        "url": `http://localhost:3000/replies/${reply_id}`,
        "method": "DELETE",
        "headers": {
          "cache-control": "no-cache",
        }
      }
    
      $.ajax(settings).done(function (response) {
        $(event.target).closest(".reply-comment").remove();
      });
    });
  </script>
  <script>
    $('.new_comment').submit(function (evt) {
        let content = $('#comment_content').val();
        if (content === "" || content.length === 0 || content == null|| !content.replace(/\s/g, '').length){
            evt.preventDefault();
            alert('Comment cannot be blank!');
            return false;
        }
    })
  </script>
<% end %>

<script>
$(document).ready(function(){
  let star5 = <%= @company.reviews.star(5).count %>;
  let star4 = <%= @company.reviews.star(4).count %>;
  let star3 = <%= @company.reviews.star(3).count %>;
  let star2 = <%= @company.reviews.star(2).count %>;
  let star1 = <%= @company.reviews.star(1).count %>;
  google.charts.setOnLoadCallback(function() { drawBasic(
    star5,star4,star3,star2,star1
    ); 
  });
});
</script>