<% if current_user %>
  <script>
    $(document).ready(function(){
        var rated = 0;
        <% if @cur_review %>
        rated = <%=  @cur_review.rating %>;
        <% end %>
    
        let stars = $(`#stars`).find(`li`).parent().children('li.star');
        for (let i = 0; i < rated; i++) {
            $(stars[i]).addClass('selected');
        }
        $('#stars li').on('mouseover', function(){
            var onStar = parseInt($(this).data('value'), 10); // The star currently mouse on
    
            // Now highlight all the stars that's not after the current hovered star
            $(this).parent().children('li.star').each(function(e){
                if (e < onStar) {
                    $(this).addClass('hover');
                }
                else {
                    $(this).removeClass('hover');
                }
            });
    
        }).on('mouseout', function(){
            $(this).parent().children('li.star').each(function(e){
                $(this).removeClass('hover');
            });
        });
    
    
        $('#stars li').on('click', function(){
            var onStar = parseInt($(this).data('value'), 10); 
            var stars = $(this).parent().children('li.star');
    
            for (i = 0; i < stars.length; i++) {
                $(stars[i]).removeClass('selected');
            }
    
            for (i = 0; i < onStar; i++) {
                $(stars[i]).addClass('selected');
            }
    
    
            var ratingValue = parseInt($('#stars li.selected').last().data('value'), 10);
            var user_id = <%= current_user.id %>;
            var company_id = <%= @company.id %>;
            var settings = {
                "async": true,
                "crossDomain": true,
                "url": `http://localhost:3000/companies/${company_id}/reviews`,
                "method": "POST",
                "headers": {
                    "Content-Type": "application/json",
                    "cache-control": "no-cache",
                },
                "processData": false,
                "data":  `{"rating":"${ratingValue}", "user_id":"${user_id}"}`
            }
    
            $.ajax(settings).done(function (response) {
                $( ".avg-count" ).text(`${response.count} reviews `);
                $( ".avg" ).html(`${response.average} <i class='fa fa-star fa-fw'></i>`);
                google.charts.setOnLoadCallback(function() { 
                  drawBasic(response.review['5'],response.review['4'],response.review['3'],response.review['2'],response.review['1']); 
                });
            });
        });
    });
  </script>
  <script>
    $(document).ready(function(){
        $("body").delegate(".reply-button", "click",function(event){
          let comment_id = $(event.target).attr('id');
          event.preventDefault();
          if($(event.target).closest(".comment").find(".reply-form").length != 0){
            return;
          }
          $(event.target).closest(".comment").after(`
          <div class="reply-form">
            <div class="row" style="padding-top:10px;">
              <div class="col-md-1">
              </div>
              <div class="col-md-1">
                <% if current_user.picture.presence %>
                  <%= image_tag(current_user.picture.thumb.url, class: "rounded-circle mx-auto d-block float-left", alt: "image", width: "75px", height: "75px") %>
                <% else %>
                  <img src="http://www.personalbrandingblog.com/wp-content/uploads/2017/08/blank-profile-picture-973460_640-300x300.png"
                        class="rounded-circle mx-auto d-block" alt="image" width="75px" height="75px">
                <% end %>
              </div>
              <div class="col-md-10" style="padding-left:30px;">
                <li>
                  <textarea rows="2" cols="60" placeholder="Write your comment here" class = "reply-text"></textarea>
                </li>
                <li>
                <input type="submit" name="commit" value="Comment" id="${comment_id}"  class = "button reply">
                </li>
              </div>
            </div>
          </div>
      `);
        });
    
    
        $("body").delegate(".reply", "click",function(event){
            let comment_id = $(event.target).attr('id');
            let content = $(event.target).closest(".reply-form").find(".reply-text").val();
            content = content.trim();
            if (content === "" || content.length === 0 || content == null|| !content.replace(/\s/g, '').length){
              alert('Comment cannot be blank!');
              return;
            }
            let user_id = <%= current_user.id %>;
            let company_id = <%= @company.id %>;
            let user_name = `<%= current_user.name %>`;
            var settings = {
              "async": true,
              "crossDomain": true,
              "url": `http://localhost:3000/companies/${company_id}/comments/${comment_id}/replies`,
              "method": "POST",
              "headers": {
                "Content-Type": "application/json",
                "cache-control": "no-cache",
              },
              "processData": false,
              "data":  `{"content":"${content}", "user_id":"${user_id}"}`
            }
    
            $.ajax(settings).done(function (response) {
              $(event.target).closest(".reply-form").replaceWith(`
                <div class="reply-comment">
                  <div class="row">
                    <div class="col-md-1 align-self-center">
                    </div>
                    <div class="col-md-1 align-self-center">
                      <% if current_user.picture.presence %>
                        <%= image_tag(current_user.picture.thumb.url, class: "rounded-circle mx-auto d-block float-left", alt: "image", width: "75px", height: "75px") %>
                      <% else %>
                        <img src="http://www.personalbrandingblog.com/wp-content/uploads/2017/08/blank-profile-picture-973460_640-300x300.png"
                          class="rounded-circle mx-auto d-block" alt="image" width="75px" height="75px">
                      <% end %>
                    </div>
                    <div class="col-md-10">
                      <div class="card" style="border: none">
                        <div class="card-body">
                          <a href="/users/${user_id}">${user_name}</a>
                          <span class="date">just now</span>
                          <p>${content}</p>
                            <a href="#" id="${response.data.id}" class="reply-delete">Delete</a>
                            <a href="#" id="${response.data.id}" class="reply-edit">Edit</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `);
            });
    
        });
    
    });
  </script>
  <script>
    $("body").delegate(".reply-edit", "click",function(event){

      let reply_id = $(event.target).attr('id');
      let current_content = $(event.target).closest(".reply-comment").find("p").text();
      event.preventDefault();
      $(event.target).closest(".reply-comment").replaceWith(`
          <div class="reply-form">
            <div class="row" style="padding-top:10px;">
              <div class="col-md-1">
              </div>
              <div class="col-md-1">
                <% current_user && if current_user.picture.presence %>
                  <%= image_tag(current_user.picture.thumb.url, class: "rounded-circle mx-auto d-block float-left", alt: "image", width: "75px", height: "75px") %>
                <% else %>
                  <img src="http://www.personalbrandingblog.com/wp-content/uploads/2017/08/blank-profile-picture-973460_640-300x300.png"
                        class="rounded-circle mx-auto d-block" alt="image" width="75px" height="75px">
                <% end %>
              </div>
              <div class="col-md-10" style="padding-left:30px;">
                <li>
                  <textarea rows="2" cols="60" placeholder="Write your comment here" class = "reply-text">${current_content}</textarea>
                </li>
                <li>
                <input type="submit" name="commit" value="Update" id="${reply_id}"  class = "button reply-update">
                </li>
              </div>
            </div>
          </div>
      `);
    });
  </script>
  <script>
    $("body").delegate(".reply-update", "click",function(event){
      event.preventDefault();
      let reply_id = $(event.target).attr('id');
      let content = $(event.target).closest(".reply-form").find(".reply-text").val();
      
      content = content.trim();
      if (content === "" || content.length === 0 || content == null|| !content.replace(/\s/g, '').length){
            alert('Comment cannot be blank!');
            return false;
      }
      let user_id = <%= current_user.id %>;
      let company_id = <%= @company.id %>;
      let user_name = `<%= current_user.name %>`;
      var settings = {
        "async": true,
        "crossDomain": true,
        "url": `http://localhost:3000/replies/${reply_id}`,
        "method": "PUT",
        "headers": {
          "Content-Type": "application/json",
          "cache-control": "no-cache",
        },
        "processData": false,
        "data": `{"content":"${content}"}`
      }
    
      $.ajax(settings).done(function (response) {
        $(event.target).closest(".reply-form").replaceWith(`
        <div class="reply-comment">
          <div class="row">
            <div class="col-md-1 align-self-center">
            </div>
            <div class="col-md-1 align-self-center">
              <% if current_user.picture.presence %>
                <%= image_tag(current_user.picture.thumb.url, class: "rounded-circle mx-auto d-block float-left", alt: "image", width: "75px", height: "75px") %>
              <% else %>
                <img src="http://www.personalbrandingblog.com/wp-content/uploads/2017/08/blank-profile-picture-973460_640-300x300.png"
                  class="rounded-circle mx-auto d-block" alt="image" width="75px" height="75px">
              <% end %>
            </div>
            <div class="col-md-10">
              <div class="card" style="border: none">
                <div class="card-body">
                  <a href="/users/${user_id}">${user_name}</a>
                  <span class="date">just now</span>
                  <p>${content}</p>
                    <a href="#" id="${reply_id}" class="reply-delete">Delete</a>
                    <a href="#" id="${reply_id} class="reply-edit">Edit</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `);
      });
    });
  </script>
  <script>
    $("body").delegate(".reply-delete", "click",function(event){
      event.preventDefault();
      let reply_id = $(event.target).attr('id');
      var r = confirm("Delete this comment?");
      if (r == false) {
          return;
      }
      var settings = {
        "async": true,
        "crossDomain": true,
        "url": `http://localhost:3000/replies/${reply_id}`,
        "method": "DELETE",
        "headers": {
          "cache-control": "no-cache",
        }
      }
    
      $.ajax(settings).done(function (response) {
        $(event.target).closest(".reply-comment").remove();
      });
    });
  </script>
  <script>
    $('.new_comment').submit(function (evt) {
        let content = $('#comment_content').val();
        if (content === "" || content.length === 0 || content == null|| !content.replace(/\s/g, '').length){
            evt.preventDefault();
            alert('Comment cannot be blank!');
            return false;
        }
    })
  </script>
<% end %>

<script>
$(document).ready(function(){
  let star5 = <%= @company.reviews.star(5).count %>;
  let star4 = <%= @company.reviews.star(4).count %>;
  let star3 = <%= @company.reviews.star(3).count %>;
  let star2 = <%= @company.reviews.star(2).count %>;
  let star1 = <%= @company.reviews.star(1).count %>;
  google.charts.setOnLoadCallback(function() { drawBasic(
    star5,star4,star3,star2,star1
    ); 
  });
});
</script>